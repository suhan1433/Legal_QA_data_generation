# Legal_QA_data_generation
법률 QA데이터를 생성할 때, 환각현상을 줄이는 것이 중요하다. 이 문제를 해결하기 위해 시도한 방법들을 작성함
법률 데이터 중 도메인을 관세로 하여 시도

- [1. 법률 데이터 이해 및 분석](#-1.-법률-데이터-이해-및-분석)
- [2. 데이터 소스](#-2.-데이터-소스)
- [3. 데이터 생성 실험](#-3.-데이터-생성-실험)
- [4. 모델 선정](#-4.-모델-선정)
- [5. 검증 방법](#-5.-검증-방법)
- [6. 예상 데이터 생성 비용](#-6.-예상-데이터-생성-비용)
- [7. 한계점 및 개선 필요 사항](#-7.-한계점-및-개선-필요-사항)

---

# 1. 법률 데이터 이해 및 분석

## 예시
법률의 경우 Q를 만들 때 상황을 함께 제공하여 질문을 해야한다고 생각함.

```python
"수입자는 해외 공급자와 특정 원재료에 관한 계약을 체결하고, 이를 활용하여 제품 A를 제조함. 이후 제품 A 판매로 발생한 순매출액의 일부를 해외 공급자에게 사후 지급하고 있음.
업체 측은 해당 지급액이 직접적인 수입물품 대가가 아니라, 수입 원재료를 사용하여 제조한 제품 A의 판매성과에 따른 지급이므로 수입과 무관하다고 주장함.
이 경우, 제품 A 판매에 따라 지급한 금액을 과세 대상으로 볼 수 있는가?",
```

## **질문 구조 분석**

- 상황 배경 + 사실관계
    
    수입자(청구인)는 해외 공급자(제3자)와

  **→** **당사자 관계**
    
    특정 원재료 계약을 체결하고, 이를 활용하여 제품 A를 제조함. 이후 제품 A 판매로 발생한 순매출액의 일부를 해외 공급자에게 사후 지급하고 있음 

  **→ 거래 구조**
    
    업체 측은 해당 지급액이 직접적인 수입물품 대가가 아니라, 수입 원재료를 사용하여 제조한 제품 A의 판매성과에 따른 지급

  **→ 지급조건**
    
    이므로 수입과 무관하다고 주장함.

  **→ 주장 차이**
    
- 쟁점
    
    제품 A 판매에 따라 지급한 금액을 과세 대상으로 볼 수 있는가?
    

## **구조 분석 설명**

모든 데이터들이 **“상황배경 +사실관계 + 쟁점”** 구조이다

- 상황 배경 + 사실관계 :
    1. 당사지 관계 : 원고(청구인), 피고(세관장·관세청장 등), 제3자(해외 공급사, 모회사 등)의 관계
    2. 거래 구조 : 수입자가 어떤 회사로부터 어떤 물품을 어떤 조건으로 수입했는지 등
    3. 지급 조건 : 물품 대금, 로열티·수수료, 기술료, 마케팅비 등 구체적인 금액과 지급 방식
    4. 주장 차이 : 과세 여부에 대한 양측 주장
- 쟁점 : 위 상황에서 과세 여부

## **결론**

즉) 데이터셋을 만들어야 한다면, 관세법령정보포털 데이터로 3가지를 생성해야 함.

- 사건 요지(상황배경 + 사실관계)
- 쟁점(질문으로 변환)
- 판단 이유(답변으로 변환)

---

# 2. 데이터 소스

관세청 도메인에 적합한 데이터셋을 “**관세법령정보포털”의 데이터로 설정**

 사용 할만한 데이터는 총 3가지

1. 판례문, 결정례
2. 관세법
3. WCO, WTO

## 판례문, 결정례

과세전적부심사, 심사청구, 심판청구, 소송 카테고리 존재

- 과세전적부심사 : 
세금을 부과하기 전에(과세예고 통지 단계) 납세자가 “이 과세는 부당하다”고 미리 다투는 절차
- 심사청구 : 
세금이 실제로 부과된 후 납세자가 불복하면 국세청장·관세청장 등에게 “심사해 달라”고 청구하는 절차
- 심판청구 : 
조세심판원(국세심판원, 관세심판원 등)에 제기하는 불복 절차
- 소송 : 
위 절차들로도 납득이 안 되면 행정법원에 소송을 제기

→ 이 중 과세전적부심사 데이터를 사용하여 생성

**과세전적부심사를 사용한 이유**

1. 전문가가 작성한 쟁점 사항이 있기에, LLM이 판단하여 질문 유형을 만드는 걸 대체 하고자 함

```python
e.g. "쟁점사항": 
① 쟁점처분이 절차적으로 위법하다는 청구주장의 당부
② 쟁점물품에 대하여 한-미 FTA에 따른 협정관세율의 적용을 배제한 처분의 당부
```

2. 관세청에 필요한 정보인 관세법, WTO, WCO를 전부 아우르는 내용임
    - 납세자의 주장에 세관이 심사를 할 때, 관세법, WTO, WCO를 전부 인용하여 답변을 함

총 데이터 수 : 3729개

청구경위, 청구인주장, 처분청주장, 쟁점사항, 심리 및 판단, 결론 존재

<img width="307" height="395" alt="image" src="https://github.com/user-attachments/assets/db76846f-dcff-443d-8bc9-7c481fd30f34" />
크롤링 결과

---

# 3. 데이터 생성 실험

## 프롬프트 작성

질문 프롬프트 작성 규칙

1. 페르소나 주입하기
2. 중복적인 요구사항 없애기 (토큰량 증가 및 모델 이해력 저하)
3. Few-Shot 작성 시 주의 (할루시네이션 가능성 존재)
4. 부정어 사용 금지
    
    e.g. A말고 B, 요약하지 말고 인용구만 뽑아줘
    
    1. 부정은 되도록 긍정문으로 작성. ( 예시. "A말고 B" - "B만 (허용목록))
    
    2. 부정어는 문장 바깥으로 분리하여, 문단의 끝에 작성 (예시. 절대 출력하지 말아주세요).
    
5. 프롬프트에 지시를 나누어 순차적으로 생성
(예시. 1차 생성 - 2차 필터링 - 3차 포맷 - 4차 최종 답변).
6. 사용하는 LLM API에 따라 효과적인 형식이 존재
    - GPT-5에서 xml형식으로 reflection을 넣는건 효과적

 https://cookbook.openai.com/examples/gpt-5/gpt-5_prompting_guide

## 질문 생성

**기존 (Bottom-Up)**

청크들을 활용하여 청크들을 파악하고 그안에서 쟁점을 파악 후 질문유형 중 선택하여 만들기

문제점) LLM이 판단한 쟁점이 정말 의미 있는지 판단하기 힘들며, 그게 정말 질문유형과 유사한지 파악하기 힘듦

**관세청 방법(Top-Down)**

주어진 쟁점을 활용하여, 그 기반으로 청크를 활용하여 질문을 만드는 방법

장점) 전문가의 핵심 쟁점을 활용 → 의미있는 질문 생성

**질문 만들기**

**과세저적부심사(데이터 생성 시 사용)** 청구경위, 청구인주장, 처분청주장, 쟁점사항, 심리 및 판단, 결론 존재

총 3729개 문서가 존재하며, 각 문서 당 평균 3개의 쟁점이 존재 → 3729x3개 이상의 QA셋 생성 가능 

e.g. 쟁점

```python
쟁점사항: 
① 청구법인이 ‘프랜차이즈 계약’에 따라 지급한 프랜차이즈 수수료를 「관세법」 제30조 제1항 제4호에 따른 권리를 사용하는 대가로 보아 과세한 처분의 당부
② 쟁점처분이 신의성실원칙에 위배되는지 여부",
```

e.g. 참고 문서

```python
chunk = """
"주문": "인천세관장이 2023.10.17., 2024.1.12. 및 2024.4.1. 청구법인에게 한 관세 OOO원, 부가가치세 OOO원 합계 OOO원의 부과처분은,1. 청구법인이 프랜차이즈 계약에 따라 A에게 지급한 금액 중 물품의 수입 이후 주로 국내에서 이루어진 활동 및 상표권 사용과 직접 관련이 없는 매출 등과 관련하여 수입물품의 과세가격에 가산되지 아니하는 금액을 재조사하여 그 결과에 따라 과세표준과 세액을 경정하고,2. 나머지 심판청구는 기각한다.",
"청구경위": "가. 청구법인은 네덜란드 소재 B(이하 “b”라 한다)가 100% 지분을 소유한 E 제품의 국내 판매법인으로, 2014.10.29. A(이하 “a”라 한다)와 E 매장 운영을 위한 ‘프랜차이즈 계약(FRANCHISE AGREEMENT, 이하 “쟁점계약”이라 한다)’을, 2014.7.7. 등에 C(이하 “c”라 한다)와 가구 및 생활용품 등의 수입을 위한 ‘제품 및 서비스 제공에 대한 계약(AGREEMENT FOR SUPPLY OF PRODUCTS AND SERVICE, 이하 “제품제공계약”이라 한다)’을 각 체결하였다...",
"청구인주장": "(1) 청구법인이 쟁점금액을 지급하고 허여받은 권리는 「관세법」제30조 제1항 제4호에 해당하는 권리가 아니다.(가) 쟁점금액은 쟁점계약에 따른 매장 운영권의 허여 및 매장 운영에 필요한 지적재산권의 사용에 대한 대가로 지급하는 가맹비이다.청구법인은 E 매장의 운영을 위하여 a와 쟁점계약을 체결하였다. 쟁점계약에 따르면, 가맹본부(a)는 청구법인에게 국내 매장의 독점 운영권, 국내 매장에서 제공되는 노하우와 지적재산권, 리테일 시스템 및 서비스를 제공한다...",
"처분청주장": "(1) 청구법인이 쟁점금액을 지급하고 허여받은 권리는 「관세법」 제30조 제1항 제4호에서 규정하고 있는 권리에 해당한다.「관세법」 제30조 제1항은 “수입물품의 과세가격은 우리나라에 수출하기 위하여 판매되는 물품에 대하여 구매자가 실제로 지급하였거나 지급하여야 할 가격에 다음 각 호의 금액을 더하여 조정한 거래가격으로 한다”고 규정하고...",
"심리 및 판단": "[쟁점물품설명][사실관계및판단](1) 선행처분의 경위 및 불복경과는 다음과 같다.(가) 서울세관장은 선행 관세조사결과, 청구법인이 2014.11.27.부터 2016.9.2.까지 수입한 신고건에 대하여 a에 지급한 프랜차이즈 수수료(순매출액의 3%)는 「관세법」 제30조 제1항 제4호에 따른 권리를 사용하는 대가로 지급되었으므로 수입물품의 과세가격에 가산되어야 한다고 판단하여...",
"결론": "이 건 심판청구는 심리결과 청구주장이 일부 이유 있으므로 「관세법」제131조와 제128조 제1항 제2호 및 제3호에 의하여 주문과 같이 결정한다."
"""
```

## 질문 Prompt

```python
# 생성 질의 D (A 수정, model: gpt-5), default

SYSTEM_PROMPT = """당신은 관세/무역/수입 관련 실무 전문가입니다. 
판례/결정례를 분석하여 실제 세관이나 관세사 업무에서 발생할 수 있는 실무적 질의를 생성합니다.

**핵심 역할:**
1. 판례/결정례에서 핵심 쟁점 파악
2. 법률용어를 일반 업무용어로 변환
3. 실무에서 발생 가능한 유사 상황 설계

**법률용어 변환 원칙:**
- "A(B)" 형태 → B의 일반적 설명 활용
- "A로 보아", "A라 한다" → 해당 내용의 구체적 설명 활용
- 조문번호/세번 → 실제 적용되는 구체적 내용으로 변환
- 전문용어 → 실무자가 이해하기 쉬운 표현으로 변환

**질의 생성 기준:**
- 세관 현장에서 실제 발생할 수 있는 복잡한 거래 구조
- 법적 해석이 모호한 경계선상의 사례
- 당사자 간 이해관계가 상충하는 상황
- 수입자와 세관 간 견해차이가 예상되는 사안

**출력 형식:**
{
    "analysis": "문서의 핵심 쟁점과 법적 논점 분석",
    "qa_pairs": [{"scenario": "구체적 거래 상황 (ㅇ 기호로 2-4개 상황)", "question": "핵심 질의 (단순명료한 의문문 형태)"}]
}

**기본 원칙:**
- 관세법 전문지식이 없는 실무자도 이해 가능한 표현
- 1-6개의 질의응답 쌍 생성 (문서 복잡도에 따라 조절)
- 한 가지 핵심 쟁점에 집중하여 질문 구성
- 실제 업무 환경에서 마주할 수 있는 현실적 상황 반영
"""

USER_PROMPT = """
문서를 분석하고 실무적 쟁점을 바탕으로 관세 실무 질의를 생성하세요.

[분석 대상 문서]
{content}

**생성 절차:**
1. 문서의 핵심 쟁점과 법적 논점 파악
2. 법률용어를 일반 업무용어로 변환
3. 실무에서 발생 가능한 유사 상황 설계
4. 당사자 간 견해차이를 반영한 복잡한 거래 구조 구성

**작성 요구사항:**

**거래 상황 (scenario):**
- "ㅇ" 기호로 2-4개의 구체적 상황 나열
- A사, B사, C사 등으로 익명화
- 구체적 금액, 비율, 기간 등 수치 포함
- 수입자의 주장과 세관의 입장을 모두 반영
- 실제 발생 가능한 복잡한 거래 구조

**질의 내용 (question):**
- "~해야 하는지?", "~할 수 있는지?" 형태의 단순명료한 의문문
- 법률용어 사용 금지 (문서 내 일반 설명 활용)
- 핵심 쟁점 하나에만 집중
- 실무자가 즉시 이해할 수 있는 표현

**예시 형태:**
거래 내용: ㅇ 수입자 A사는 미국 B사에 장비 개발을 의뢰하여 기술자료를 받고 미화 400만불을 지급함. ㅇ 해당 기술이 적용된 시제품 수입 시 시제품 가격(100만불)만 신고함. ㅇ A사는 기술료는 시제품과 별도 비용이라고 주장하나, 세관은 관련성을 문제삼고 있음.

질의 내용: 기술자료 대가 미화 400만불을 시제품 수입신고 시 과세가격에 포함해야 하는지?

**중요사항:**
- 관세법 조문번호나 전문용어 대신 구체적 내용 설명 사용
- 실무에서 실제 마주할 수 있는 현실적 상황 반영
- 수입자와 세관 양쪽 입장을 균형있게 제시
- 법적 해석이 모호한 경계선상의 사례 중심

위 요구사항에 따라 문서를 분석하고 실무적 질의를 생성해주세요.
"""

```

### 현재 프롬프트 장점

1. 질문 생성의 할루시네이션 감소
    - 기존 LLM이 원문을 파악 후 쟁점을 선정 하여 질문 만드는 형식의 경우 할루시네이션이 존재
    - Few-Shot을 주어 유사한 질문을 생성을 요청을 할 경우에도 할루시네이션 문제가 존재함
        - Few-Shot에 추가했던 거래구조 형식을 그대로 인용하여 원문에 없는 요소(예: 삼각지급) 기반 질문이 생성됨

### 현재 프롬프트 단점

1. **쟁점 기반 질문 생성 방식의 한계**
    - **문제**: 문서 내 판례/결정례의 쟁점 위주로 질문을 만들다 보니
        - 확장적 질문 생성이 어려울 수 있음
        - 생성되는 질문 수가 적음 (데이터 부족 문제 발생)
    - 하지만 데이터 양보다 질이라고 생각하여 이 방법을 선정

→ Data Curation과정을 통해 품질 낮은 데이터를 걸러네고 정제한 데이터로 학습 했을 때, 더 높은 성능이 나옴

https://arxiv.org/pdf/2406.15126

## 답변 Prompt

```python
SYSTEM_PROMPT = """당신은 관세 실무 전문가입니다. 판례/결정례를 분석하여 실무자가 이해하기 쉬운 답변을 제공합니다.

**Golden Chunks 선정 기준:**
1. 질문 해결에 직접 필요한 법적 근거 (법조항, 판례 판단, 과세기준)
2. 핵심 쟁점과 직결되는 정보
3. 중복 없는 독립적이고 완결적인 정보

**답변 원칙:**
- 제공된 문서 정보만 사용 (추측 및 외부 정보 금지)
- "문의자님"으로 시작하여 두괄식 구조로 작성
- 각 설명마다 해당 법령만을 즉시 괄호로 명시 (참고 문서 번호는 포함하지 않음)
- 구체적 회사명 언급 금지

**출력 형식:**
<thinking>
1. 질문의 핵심 법적 쟁점 분석
2. 쟁점 해결에 필요한 법리 및 판례 식별
3. 관련 참고 문서에서 직접 답변 가능한 정보 추출
4. Golden Docs 최종 선정 (3-6개 권장)
</thinking>

<reflection>
1. 선정된 참고 문서가 질문 답변에 충분한지 검토
2. 법적 근거의 정확성 및 완결성 확인
3. 누락된 핵심 정보나 중복 정보 점검
4. 답변 논리의 일관성 검증
</reflection>

<output>
문의자님, [명확한 결론을 먼저 제시]

[상세 설명 - 각 문장마다 관련 법령만을 괄호로 즉시 명시]
예시: 과세가격에 기술료가 포함됩니다(관세법 제30조). 대법원도 동일한 견해를 제시했습니다(대법원 2023누12345).

**중요: 법령만 괄호에 표기하고 참고 문서 번호는 절대 포함하지 마세요.**
</output>

<golden_docs>
[최종 선정된 참고 문서 번호들]
예시: [1, 2]
</golden_docs>
"""

USER_PROMPT = """
질의: {QUESTION}

참고 문서 :
{CONTENT}

**답변 절차:**
1. 질의의 핵심 법적 쟁점 파악
2. 쟁점 해결에 필요한 참고 문서를 선별 및 분석
3. 법적 근거를 바탕으로 한 명확한 답변 작성

**필수 요구사항:**
- "문의자님"으로 시작
- 결론을 먼저 명확히 제시 (두괄식)
- 모든 설명 뒤에 관련 법령만을 괄호로 즉시 표기 (참고 문서 번호는 절대 포함하지 말 것)
- 구체적 회사명 언급 금지
- 제공된 문서 정보만 활용 (외부 정보 사용 금지)

위 형식에 따라 단계별로 분석하고 답변해주세요.
"""
```

# 4. 모델 선정

**Gpt-5 선정** 

GPT 4.1, GPT5, GPT5-mini로 결과를 뽑고 정성 평가

선정 기준은 아래 기준를 1-5점을 주어 평가

1. 거래구조 구체성: 거래 구조가 실무와 유사한지 실제 세관에서 겪을만한 일인지 판단
2. 단어의 일반화: 법률용어 대신 일반화를 했는지 판단 e.g. HS 8536.41로 신고 → 전압 60볼트 이하로 신고
3. 할루시네이션 없이 원문 쟁점으로 질문을 생성했는지 판단 

# 5. 검증 방법

1. 골든청크 검증
2. 생성된 QA셋으로 27B Gemma LoRA 학습 후 LLM-Judge

### 골든청크 검증

검증 방법

1. 테스트용 sub-chunk 셋을 활용해 답변을 생성
2. 동일한 질문에 대해 ChatGPT에 sub-chunk 셋을 제공하여 생성된 답변과 비교
3. 두 답변을 비교하여 골든 청크의 포함여부 파악

### 생성된 QA셋으로 27B Gemma LoRA 학습 후 LLM-Judge

검증 방법

1. 답변을 생성하면서 구성한 골든 청크와 QA셋을 활용하여 학습
2. LLM-Judge로 골든청크와 QA셋, 생성된 Answer을 주고 평가
    - 평가 지표
        - Golden 답변과의 연관성: 답변이 Gold Answer의 핵심 정보와 의미적으로 얼마나 일치하는지 평가
        - 사실성: 답변이 문서 근거와 사실적으로 정확한지 평가
        - 구체성: 답변이 구체적이고 세부적인 근거·예시를 포함하는지 평가
        - 연관성: 답변이 질문의 의도와 얼마나 밀접하게 관련되는지 평가
        - 일관성: 답변이 내부적으로 모순 없이 논리적 흐름과 용어를 유지하는지 평가
    
    | 모델 이름 | GOLD 답변과의 연관성 | 사실성 | 구체성 | 연관성 | 일관성 | 총점(avg) | 총합(%) |
    | --- | --- | --- | --- | --- | --- | --- | --- |
    | **Gemma3 27B Vanilla** | 3.66 | 3.917 | 3.211 | 4.359 | 3.997 | 3.829 | 76.576 |
    | **Gemma3 27B Epoch3** | 3.685 | 3.963 | 3.274 | 4.404 | 4.026 | 3.870 | 77.408 |

# 6. 예상 데이터 생성 비용

- 123개 생성 시 QA데이터 토큰양
    - non-cached input : 약 **2,047,776토큰**
    - cached input: **약 37,008토큰**
    - output : 약 **709,155토큰**
    
- 13255개 QA데이터 생성 예상 비용

| **Model** | **Non-cached input** | **Cached input** | **Output** | **총 비용** |
| --- | --- | --- | --- | --- |
| **gpt-5** | $305.95 | $0.60 | $847.33 | **$1,153.88** |
| **gpt-5-mini** | $62.15 | $0.12 | $169.73 | **$232.00** |
| **gpt-4o** | $612.05 | $5.50 | $847.33 | **$1,464.88** |
| **gpt-4.1** | $490.00 | $2.27 | $677.86 | **$1,170.13** |
| **gpt-5(flex)** | $153.00 | $0.24 | $424.17 | **$577.41** |

→ gpt-5(flex)로 선정

flex란? [OpenAI Platform](https://platform.openai.com/docs/guides/flex-processing?api-mode=responses)

느린 응답속도와 가끔 리소스를 사용할 수 없는 대신, 저렴한 비용을 제공

데이터 생성 등 비동기적 작업에 효과적

- 1개 프로세스로 실행 시 걸린 시간

| Question 생성 소요시간 및 비용 (123개) | 4시간 21분, 0.72달러 (새벽00-5, 느린거 같음) |
| --- | --- |
| Answer 생성 소요시간 및 비용 (123개) | 1시간 57분, 3.81달러  (오전 시간에 빠름) |

현재는 10개의 py를 동시에 실행하는 방식으로 수행하여 시간을 단축,

추후 비동기적으로 멀티 프로세싱을 할 수 있도록 코드 수정 필요

### **최종 결과**

| **사용 모델** | gpt-5(flex) |
| --- | --- |
| **총 QA쌍** | 13255개 생성, fallback 1518개 |
| **소요시간** | 질문 생성: 약 2시간, 
답변 생성: 약 12시간 |
| **비용** | 약 459달러 |

# 7. 한계점 및 개선 필요 사항

1. 데이터 생성 병렬처리 개선
    - 현재는 단순히 쉘 스크립트를 이용해 실행 중이나, 더 효율적인 비동기 병렬처리 방식으로 수정 필요
2. 도메인별 파이프라인 변경 요소 파악
    - 특정 도메인에 따라 ****데이터 전처리 방식, 프롬프트 설계, 후처리 규칙 등이 달라질 수 있음
    - 따라서 파이프라인 내에서 도메인 특화 모듈을 교체하거나 조정할 수 있는 구조로 설계 필요
3. 답변 내 판례·법률 처리 개선 방안
    - 기존 방식: 답변 뒤 괄호 안에 즉시 판례·법률 정보 삽입
    - 개선 방식: 답변 본문에서는 판례·법률 번호를 제거하고, 마지막에 출처로 일괄 표기
    - 이유: 법률 조문 번호나 판례 번호는 할루시네이션 가능성이 있음
